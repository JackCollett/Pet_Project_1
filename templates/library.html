{% extends "layout.html" %}

{% block body %}
{% if name %}

<header>
    <h1>Your Library</h1>
    You are logged in as {{ name }}. 
    <a href="/logout" class="default-link">Log out</a>.
</header>

<script>
    function drawImageOnCanvas(canvasID, imageID, brightnessSlider, currentRotation, skewNumbers, gradient, gradient_colors) {
        const canvas = document.getElementById(canvasID);
        const context = canvas.getContext('2d');
        const image = document.getElementById(imageID);

        if (!image.complete) {
            image.onload = function () {
                drawImageOnCanvas(canvasID, imageID, brightnessSlider, currentRotation, skewNumbers, gradient, gradient_colors);
            };
            return;
        }
        var new_width = image.naturalWidth;
        var new_height = image.naturalHeight;
        if (image.naturalHeight >= 1620 || image.naturalWidth >= 1000) {
        new_width = image.naturalWidth * 0.5;
        new_height = image.naturalHeight * 0.5;
        }
        canvas.width = new_width;
        canvas.height = new_height;
        context.filter = "brightness(" + brightnessSlider + "%) ";
        canvas.style.transform = "rotate(" + currentRotation + "deg) " +
        "matrix(" + skewNumbers + ") ";
        context.drawImage(image, 0, 0, canvas.width, canvas.height);
        // add gradient
        if (gradient == "True") {
        const gradient = context.createLinearGradient(0, 0, 0, canvas.height);
        color_1 = gradient_colors.slice(0, 7);
        color_2 = gradient_colors.slice(7);
        gradient.addColorStop(0, color_1);   
        gradient.addColorStop(1, color_2);
        context.globalCompositeOperation = 'overlay';
        context.fillStyle = gradient;
        context.fillRect(0, 0, canvas.width, canvas.height);     
        }
        
    };
</script>

<div class="gallery">
{% for image in library %} 
<div class="gallery-item">
    <canvas 
        id="{{ image[0] }}" 
        data-url="{{ image[1] }}"
        data-brightness="{{ image[4] }}"
        data-rotation="{{ image[3] }}"
        data-skew="{{ image[5] }}"
        data-gradient="{{ image[6] }}"
        data-gradientColors="{{ image[7] }}"
        width="500" height="800">
    </canvas>
    <img src="{{ image[1] }}" id="image{{ image[0] }}" style="display:none;">
</div>
{% endfor %} 
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvases = document.querySelectorAll('.gallery canvas');

        canvases.forEach((canvas) => {
            const imageId = 'image' + canvas.id;
            const image = document.getElementById(imageId);

            drawImageOnCanvas(canvas.id, image.id, 
                canvas.dataset.brightness, 
                canvas.dataset.rotation, 
                canvas.dataset.skew, 
                canvas.dataset.gradient, 
                canvas.dataset.gradientcolors
                );
            console.log(canvas.id)

            canvas.addEventListener('click', () => {
                const editUrl = '/edit?image_id=' + canvas.id;
                window.location.assign(editUrl);
            });
        });
    });

</script>

</div>    

{% else %}
<h1>You are not logged in.</h1> <a href="/login">Log in</a>.
{% endif %}

{% endblock %}